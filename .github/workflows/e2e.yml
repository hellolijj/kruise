name: "Create cluster using KinD"
on: push

jobs:
  kind:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@master
    - uses: engineerd/setup-kind@v0.1.0
    - name: setup-k8s
      run: |
        export KUBECONFIG="$(kind get kubeconfig-path)"
        echo $KUBECONFIG
        kubectl cluster-info
        kubectl get pods -n kube-system
    - name: install-kruise
      run: |
        kubectl apply -f https://raw.githubusercontent.com/kruiseio/kruise/master/config/crds/apps_v1alpha1_broadcastjob.yaml
        kubectl apply -f https://raw.githubusercontent.com/kruiseio/kruise/master/config/crds/apps_v1alpha1_sidecarset.yaml
        kubectl apply -f https://raw.githubusercontent.com/kruiseio/kruise/master/config/crds/apps_v1alpha1_statefulset.yaml
        kubectl apply -f https://raw.githubusercontent.com/kruiseio/kruise/master/config/manager/all_in_one.yaml
    - name: e2e-test
      run: |
        APP_PATH=/home/runner/go/src/github.com/openkruise/kruise
        mkdir -p $APP_PATH
        cp -r ./ $APP_PATH
        cd $APP_PATH
        go test ./test/e2e/ -v -args "-kubeconfig=/home/runner/.kube/kind-config-kind"